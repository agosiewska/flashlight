<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using flashlight • flashlight</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using flashlight">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flashlight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/flashlight.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using flashlight</h1>
                        <h4 class="author">Michael Mayer</h4>
            
            <h4 class="date">2019-10-12</h4>
      
      
      <div class="hidden name"><code>flashlight.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(flashlight)      <span class="co"># model interpretation</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MetricsWeighted) <span class="co"># metrics</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)           <span class="co"># data prep</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(moderndive)      <span class="co"># data</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(caret)           <span class="co"># data split</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(xgboost)         <span class="co"># gradient boosting</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ranger)          <span class="co"># random forest</span></span></code></pre></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In contrast to classic statistical modelling techniques like linear regression, modern machine learning approaches tend to provide black box results. In areas like visual computing or natural language processing, this is not an issue since there, focus usually lies on predicting things. Either the predictions are sufficiently useful in practice or the model won’t be used. However, in areas where the purpose of a statistical model is also to explain or validate underlying theories (e.g. in medicine, economics, and biology), black box models are of little use.</p>
<p>Thus, there is need to shed light into these black boxes resp. to explain machine learning models as good as possible. An excellent reference is the online book of Christoph Molnar [1]. Of special interest are <strong>model agnostic</strong> approaches that work for any kind of modelling technique, e.g. a linear regression, a neural net or a tree-based method. The only requirement is the availability of a prediction function, i.e. a function takes a data set and returns predictions.</p>
<p>To do so is the purpose of the R package <code>flashlight</code>, which is inspired by the beautiful <code>DALEX</code> package, see (<a href="https://CRAN.R-project.org/package=DALEX" class="uri">https://CRAN.R-project.org/package=DALEX</a>).</p>
<p>The main props of <code>flashlight</code>:</p>
<ol style="list-style-type: decimal">
<li><p>It is simple, yet flexible.</p></li>
<li><p>It offers model agnostic tools like model performance, variable importance, ICE profiles, partial dependence, further effects plots, and variable contribution breakdown for single observations.</p></li>
<li><p>It allows to assess multiple models in parallel.</p></li>
<li><p>It supports “group by” operations.</p></li>
<li><p>It works with case weights.</p></li>
</ol>
<p>Currently, models with numeric or binary response are supported.</p>
<p>We will now give a brief introduction to machine learning explanations and then illustrate them with the <code>flashlight</code> package.</p>
</div>
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>Important model agnostic machine learning explanations include the following aspects, amongst many other.</p>
<div id="model-performance" class="section level3">
<h3 class="hasAnchor">
<a href="#model-performance" class="anchor"></a>Model performance</h3>
<p>How precise are models if applied to unseen data? This aspect is of key interest of basically any supervised machine learning model and helps to identify the best models or, if applied to subgroup, identify problematic segments with low performance.</p>
</div>
<div id="variable-importance" class="section level3">
<h3 class="hasAnchor">
<a href="#variable-importance" class="anchor"></a>Variable importance</h3>
<p>Which variables are particularly relevant for the model? This aspect is helpful in different ways. Firstly, it might help to simplify the full modelling process by eliminating difficult to assess input variables with low explanatory power. Secondly, its pure information. Thirdly, it might help to identify problems in data structure: if one variable is extremely relevant and all others not, then there might be some sort of information leakage from the response. Thus said, variable importance considerations are very relevant for quality assurance as well.</p>
<p>Different modelling techniques offer different ways of variable importance. In linear models, we consider e.g. F-test statistics or p values, in tree-based methods, its number of splits or avarage split gains etc. A model agnostic way to assess this is called <em>permutation importance</em>: For each input variable <span class="math inline">\(X\)</span>, its values are randomly shuffled and the drop in performance with respect to a scoring function is calculated. The more important a variable, the larger the drop. If a variable can be shuffled without any impact on model precision, it is completely irrelevant. The method is described in Fisher et al. 2018 [2].</p>
</div>
<div id="effects-of-input-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#effects-of-input-variables" class="anchor"></a>Effects of input variables</h3>
<p>In linear regression, the fitted model consists of an affine linear function in the inputs. Its coefficients immediately tell us how the response is expected to change if the value of one single input variable <span class="math inline">\(X\)</span> is systematically being adapted. How to describe such effects of a variable <span class="math inline">\(X\)</span> for more complex models that include non-linearities and high-order interactions?</p>
<p>One approach that is to study <em>Individual Conditional Expectation (ICE)</em> profiles of selected observations: They show how predictions of observation <span class="math inline">\(i\)</span> react when the input variable <span class="math inline">\(X\)</span> is systematically being changed, see [3]. The more different the profiles are in shape or slope, the stronger are the interaction effects. For a linear regression without interactions, all such profiles would be parallel. ICE profiles centered at one point (or “c-ICE” profiles) help to detect interactions even better.</p>
<p>If many ICE profiles are averaged, we get <em>partial dependence profiles</em> which can be viewed as the average effect of variable <span class="math inline">\(X\)</span>, pooled over all interactions. Partial dependence plots where introduced in Friedman’s seminal 2001 article on gradient boosting [4].</p>
<p>Studying ICE and partial dependence profiles make sense as long as it make sense to investigate the effect of <span class="math inline">\(X\)</span> while holding all other predictors fixed. The unnatural such ceteris paribus assumption is, the less reasonable are the results of ICE and partial dependence. <em>Accumulated local effects</em> or <em>ALE</em> profiles [5] try to overcome this weakness of ICE and partial dependence considerations.</p>
<p>ALE profiles at positions <span class="math inline">\(x_i\)</span> are calculated as follows:</p>
<ol style="list-style-type: decimal">
<li><p>First, left derivatives <span class="math inline">\(\Delta_i\)</span> are estimated for all <span class="math inline">\(i\)</span>: Calculate slope of partial dependence line from <span class="math inline">\(x_i-\varepsilon\)</span> to <span class="math inline">\(x\)</span> based on data points in <span class="math inline">\([x_i-\varepsilon, x_i]\)</span>.</p></li>
<li><p>The uncalibrated ALE value at <span class="math inline">\(x_i\)</span> is the (integrated/accumulated) partial sum <span class="math inline">\(\sum_{j \le i} \Delta_j\)</span>.</p></li>
<li><p>In the calibration step, the effects are shifted to the level of the response variable or its predictions.</p></li>
</ol>
<p>An alternative to partial dependence and ALE profiles is to look at combined effects of <span class="math inline">\(X\)</span> including the effects from all other predictors. Such effects are estimated by averaging the predictions within values of the predictor <span class="math inline">\(X\)</span> of interest. If such prediction profile differs considerably from the observed average response, this might be a sign of model underfit. This visualization is sometimes called “marginal plot” or “M plot”, see [5]. Residual profiles immediatly show such misfits as well. In classic statistical modelling, this sort of plots are called “fitted versus covariable” plots or “residual versus covariable” plots.</p>
<p>Besides looking at <em>average</em> profiles, it is often also revealing to consider <em>quartile</em> profiles or to visualize partial dependence, response and prediction profiles in the same plot.</p>
</div>
<div id="variable-contribution-breakdown-for-single-observations" class="section level3">
<h3 class="hasAnchor">
<a href="#variable-contribution-breakdown-for-single-observations" class="anchor"></a>Variable contribution breakdown for single observations</h3>
<p>Instead of studying global variable importance and effects, there are different techniques to entangle how a <em>single prediction</em> can be decomposed into additive effects of input variables, e.g. LIME, LIVE, SHAP or breakdown (Gosiewska and Biecek [6]), see [1] and [6] for an overview. The <code>flashlight</code> package currently supports the breakdown method.</p>
<p>It works as follows: First, the visit order <span class="math inline">\((x_1, ..., x_m)\)</span> of variables is specified. Then, in the query data, the column <span class="math inline">\(x_1\)</span> is set to the constant value of <span class="math inline">\(x_1\)</span> of the observation to be explained. The change in the (weighted) average predicted value on the query data measures the contribution of <span class="math inline">\(x_1\)</span> on the prediction. This procedure is iterated over all <span class="math inline">\(x_i\)</span> until eventually, all rows in the query data are identical to the observation to be explained.</p>
<p>A complication with this approach is that the visit order is relevant, at least for non-additive models. Ideally, the algorithm could be repeated for all <span class="math inline">\(m!\)</span> possible visit orders and its results averaged per variable. This is basically what SHAP values do, see e.g. [6] for an explanation. Unfortunately, there is no efficient way to do this in a model agnostic way. Thus we use the short-cut described in [6] and implemented in the <code>ibreakdown</code> package (<a href="https://CRAN.R-project.org/package=iBreakDown" class="uri">https://CRAN.R-project.org/package=iBreakDown</a>): There, the variables <span class="math inline">\(x_i\)</span> are sorted by the size of their contribution in the same way as the breakdown algorithm but without iteration, i.e. starting from the original query data for each variable <span class="math inline">\(x_i\)</span>.</p>
<p>The <code>flashlight</code> package offers these tools in a very simple way.</p>
</div>
</div>
<div id="installation-of-flashlight" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-of-flashlight" class="anchor"></a>Installation of <code>flashlight</code>
</h2>
<p>From CRAN:</p>
<pre><code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("flashlight")</a></code></pre>
<p>Latest version from github:</p>
<pre><code>library(devtools)
install_github("mayer79/flashlight")</code></pre>
</div>
<div id="teaser" class="section level2">
<h2 class="hasAnchor">
<a href="#teaser" class="anchor"></a>Teaser</h2>
<p>Let’s start with an iris example.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Fit model</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>fit &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># Make flashlight</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>fl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> fit, <span class="dt">data =</span> iris, <span class="dt">y =</span> <span class="st">"Sepal.Length"</span>, <span class="dt">label =</span> <span class="st">"ols"</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>                 <span class="dt">metrics =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">rmse =</span> rmse, <span class="st">`</span><span class="dt">R-squared</span><span class="st">`</span> =<span class="st"> </span>r_squared))</span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co"># Performance: rmse and R-squared</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fl), <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fl, <span class="dt">by =</span> <span class="st">"Species"</span>), <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-2.png" width="672"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># Variable importance by increase in rmse</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>imp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fl)</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp, <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-3.png" width="672"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fl, <span class="dt">by =</span> <span class="st">"Species"</span>)) <span class="op">+</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="st">   </span><span class="kw">scale_fill_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.2</span>, <span class="dt">end =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-4.png" width="672"></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw"><a href="../reference/most_important.html">most_important</a></span>(imp, <span class="dv">2</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">#&gt; [1] "Petal.Length" "Species"</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># ICE profiles for Petal.Width</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-5.png" width="672"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">center =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-6.png" width="672"></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-7.png" width="672"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># Partial dependence profiles for Petal.Width</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-8.png" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-9.png" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co"># Accumulated local effects (ALE) profiles for Petal.Width</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-10.png" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-11.png" width="672"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># Prediction, response and residual profiles</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"response"</span>, <span class="dt">stats =</span> <span class="st">"quartiles"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-12.png" width="672"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"predicted"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-13.png" width="672"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"residual"</span>, <span class="dt">stats =</span> <span class="st">"quartiles"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-14.png" width="672"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co"># Response profiles, prediction profiles, partial depencence, and ALE profiles in one</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>), <span class="dt">use =</span> <span class="st">"all"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-15.png" width="672"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># Variable contribution breakdown for single observation</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fl, <span class="dt">new_obs =</span> iris[<span class="dv">2</span>, ]))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-2-16.png" width="672"></p>
</div>
<div id="flashlights-and-multiflashlights" class="section level2">
<h2 class="hasAnchor">
<a href="#flashlights-and-multiflashlights" class="anchor"></a>flashlights and multiflashlights</h2>
<p>The process of using the <code>flashlight</code> package is as follows:</p>
<ol style="list-style-type: decimal">
<li>
<p>Define a flashlight for each model. This is basically a list with optional components relevant for model interpretation:</p>
<ul>
<li><p><code>model</code>: The fitted model object like e.g. the one returned by <code>lm</code>.</p></li>
<li><p><code>data</code>: A data set used to evaluate model agnostic tools, e.g. the validation data.</p></li>
<li><p><code>y</code>: The name of the variable in <code>data</code> representing the model response.</p></li>
<li><p><code>predict_function</code>: A function taking <code>model</code> and <code>data</code> and returning numeric predictions.</p></li>
<li><p><code>linkinv</code>: Inverse link function used to retransform the values returned by <code>predict_function</code>. Defaults to the identity function <code>function(z) z</code>.</p></li>
<li><p><code>w</code>: The name of the variable in <code>data</code> representing the case weights.</p></li>
<li><p><code>by</code>: A character vector of names of grouping variables in <code>data</code>. These will be used to stratify all results.</p></li>
<li><p><code>metrics</code>: A named list of metrics. These functions need to be available in the workspace and require arguments <code>actual</code>, <code>predicted</code>, <code>w</code> (case weights) as well as a placeholder … for further arguments. All metrics available in R package <code>MetricsWeighted</code> are suitable.</p></li>
<li><p><code>label</code>: The label of the model. This is the only required input when building the flashlight.</p></li>
</ul>
</li>
<li>
<p>Calculate relevant information by calling the key functions:</p>
<ul>
<li><p><code>light_performance</code>: Calculates performance measures regarding different metrics, possibly within subgroups and weighted by case weights.</p></li>
<li><p><code>light_importance</code>: Calculates variable importance (worsening in performance by random shuffling) for each or a subset of variables. Possibly within subgroups and using case weights. The most important variable names can be extracted by the function <code>most_important</code> on the result of <code>light_importance</code>.</p></li>
<li><p><code>light_ice</code>: Calculates ICE profiles across a couple of observations, possibly within groups.</p></li>
<li><p><code>light_profile</code>: Calculates partial dependent profiles across a covariable, possibly within groups. Generated by calling <code>light_ice</code> and aggregating the results. The function is flexible: it can also be used to generate ALE, response, residual or prediction profiles or calculate (weighted) quartiles instead of (weighted) means.</p></li>
<li><p><code>light_effects</code>: Combines partial dependence, response and prediction profiles. ALE profiles can be added as well.</p></li>
<li><p><code>light_breakdown</code>: Calculates variable contribution breakdown for a single observation.</p></li>
</ul>
</li>
<li><p>Plot the result: Each of these functions offer a <code>plot</code> method with minimal visualization of the results through <code>ggplot2</code>. The resulting plot can be customized by adding <code>theme</code> and other <code>ggplot</code> elements. If customization is insufficient, you can extract the data slot in the object returned by above key functions and build an own plot.</p></li>
</ol>
<p>In practice, multiple flashlights are being defined and evaluated in parallel. By the help of a <code>multiflashlight</code> object, The <code>flashlight</code> packages provides as much support as possible to avoid any redundancy. It can be used to combine fully specified flashlights or, and that is the more interesting option, take minimally defined flashlights (e.g. only <code>label</code>, <code>model</code> and <code>predict_function</code>) and add common arguments like <code>y</code>, <code>by</code>, <code>data</code> and/or <code>w</code> (case weights) in calling <code>multiflashlight</code>. If necessary, the resulting completed flashlights contained in the multiflashlight can be extracted again by <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>.</p>
<p>All key functions are defined for both <code>flashlight</code> and <code>multiflashlight</code> objects.</p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>As illustration, we use the data set <code>house_prices</code> with information on 21613 houses sold in King County between May 2014 and May 2015. It is shipped along with R package <code>moderndive</code>.</p>
<p>The first few observations look as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(house_prices)</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co">#&gt; # A tibble: 6 x 21</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co">#&gt;   id    date        price bedrooms bathrooms sqft_living sqft_lot floors</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="co">#&gt;   &lt;chr&gt; &lt;date&gt;      &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;       &lt;int&gt;    &lt;int&gt;  &lt;dbl&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co">#&gt; 1 7129~ 2014-10-13 2.22e5        3      1           1180     5650      1</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co">#&gt; 2 6414~ 2014-12-09 5.38e5        3      2.25        2570     7242      2</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co">#&gt; 3 5631~ 2015-02-25 1.80e5        2      1            770    10000      1</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co">#&gt; 4 2487~ 2014-12-09 6.04e5        4      3           1960     5000      1</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co">#&gt; 5 1954~ 2015-02-18 5.10e5        3      2           1680     8080      1</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co">#&gt; 6 7237~ 2014-05-12 1.23e6        4      4.5         5420   101930      1</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co">#&gt; # ... with 13 more variables: waterfront &lt;lgl&gt;, view &lt;int&gt;,</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="co">#&gt; #   condition &lt;fct&gt;, grade &lt;fct&gt;, sqft_above &lt;int&gt;, sqft_basement &lt;int&gt;,</span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="co">#&gt; #   yr_built &lt;int&gt;, yr_renovated &lt;int&gt;, zipcode &lt;fct&gt;, lat &lt;dbl&gt;,</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="co">#&gt; #   long &lt;dbl&gt;, sqft_living15 &lt;int&gt;, sqft_lot15 &lt;int&gt;</span></span></code></pre></div>
<p>Thus we have access to many relevant infos like size, condition as well as location of the objects. We want to use these variables to predict the (log) house prices by the help of the following regression techniques and shed some light on them:</p>
<ul>
<li><p>linear regression,</p></li>
<li><p>random forests, and</p></li>
<li><p>boosted trees.</p></li>
</ul>
<p>We use 70% of the data to calculate the models, 20% for evaluating their performance and for explaining them. 10% we keep untouched.</p>
<div id="data-preparation" class="section level3">
<h3 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data preparation</h3>
<p>Let’s do some data preparation common for all models under consideration.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>prep &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(house_prices, </span>
<span id="cb21-2"><a href="#cb21-2"></a>                  <span class="dt">log_price =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(price),</span>
<span id="cb21-3"><a href="#cb21-3"></a>                  <span class="dt">grade =</span> <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(grade)),</span>
<span id="cb21-4"><a href="#cb21-4"></a>                  <span class="dt">year =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(lubridate<span class="op">::</span><span class="kw"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(date)),</span>
<span id="cb21-5"><a href="#cb21-5"></a>                  <span class="dt">age =</span> lubridate<span class="op">::</span><span class="kw"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(date) <span class="op">-</span><span class="st"> </span>yr_built,</span>
<span id="cb21-6"><a href="#cb21-6"></a>                  <span class="dt">zipcode =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(zipcode)),</span>
<span id="cb21-7"><a href="#cb21-7"></a>                  <span class="dt">waterfront =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(waterfront, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">FALSE</span>, <span class="ot">TRUE</span>), <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"no"</span>, <span class="st">"yes"</span>)))</span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a>x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"grade"</span>, <span class="st">"year"</span>, <span class="st">"age"</span>, <span class="st">"sqft_living"</span>, <span class="st">"sqft_lot"</span>, <span class="st">"zipcode"</span>, </span>
<span id="cb21-10"><a href="#cb21-10"></a>       <span class="st">"condition"</span>, <span class="st">"waterfront"</span>)</span></code></pre></div>
</div>
<div id="modelling" class="section level3">
<h3 class="hasAnchor">
<a href="#modelling" class="anchor"></a>Modelling</h3>
<p>The random forest can directly work with this data structure. However, for the linear model, we need a small function with additional feature engineering, i.e. log transforming some input and categorizing the zipcode in large groups. Similarly, for XGBoost, such wrapper function turns non-numeric input variables to numeric. We will make use of these functions for both data preparation and prediction.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Data wrapper for the linear model</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>prep_lm &lt;-<span class="st"> </span><span class="cf">function</span>(data) {</span>
<span id="cb22-3"><a href="#cb22-3"></a>  data <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">sqrt_living =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(sqft_living),</span>
<span id="cb22-5"><a href="#cb22-5"></a>           <span class="dt">sqrt_lot =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(sqft_lot),</span>
<span id="cb22-6"><a href="#cb22-6"></a>           <span class="dt">zipcode =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(zipcode <span class="op">%/%</span><span class="st"> </span><span class="dv">10</span>))</span>
<span id="cb22-7"><a href="#cb22-7"></a>}</span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co"># Data wrapper for xgboost</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>prep_xgb &lt;-<span class="st"> </span><span class="cf">function</span>(data, x) {</span>
<span id="cb22-11"><a href="#cb22-11"></a>  data <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span>(x) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span>(is.numeric), as.integer) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/data.matrix.html">data.matrix</a></span>()</span>
<span id="cb22-15"><a href="#cb22-15"></a>}</span></code></pre></div>
<p>Then, we split the data and train our models.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Train / valid / test split (70% / 20% / 10%)</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">56745</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a>ind &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createFolds</a></span>(prep[[<span class="st">"log_price"</span>]], <span class="dt">k =</span> <span class="dv">10</span>, <span class="dt">list =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a>train &lt;-<span class="st"> </span>prep[ind <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, ]</span>
<span id="cb23-6"><a href="#cb23-6"></a>valid &lt;-<span class="st"> </span>prep[ind <span class="op">%in%</span><span class="st"> </span><span class="dv">2</span><span class="op">:</span><span class="dv">3</span>, ]</span>
<span id="cb23-7"><a href="#cb23-7"></a>test &lt;-<span class="st"> </span>prep[ind <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]</span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a>(form &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/delete.response.html">reformulate</a></span>(x, <span class="st">"log_price"</span>))</span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="co">#&gt; log_price ~ grade + year + age + sqft_living + sqft_lot + zipcode + </span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="co">#&gt;     condition + waterfront</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>fit_lm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/update.formula.html">update.formula</a></span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(sqft_living<span class="op">^</span><span class="dv">2</span>)), <span class="dt">data =</span> <span class="kw">prep_lm</span>(train))</span>
<span id="cb23-13"><a href="#cb23-13"></a></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="co"># Random forest</span></span>
<span id="cb23-15"><a href="#cb23-15"></a>fit_rf &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span>(form, <span class="dt">data =</span> train, <span class="dt">seed =</span> <span class="dv">8373</span>)</span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"R-squared OOB:"</span>, fit_rf<span class="op">$</span>r.squared)</span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co">#&gt; R-squared OOB: 0.7842605</span></span>
<span id="cb23-18"><a href="#cb23-18"></a></span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="co"># Gradient boosting</span></span>
<span id="cb23-20"><a href="#cb23-20"></a>dtrain &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="kw">prep_xgb</span>(train, x), <span class="dt">label =</span> train[[<span class="st">"log_price"</span>]])</span>
<span id="cb23-21"><a href="#cb23-21"></a>dvalid &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="kw">prep_xgb</span>(valid, x), <span class="dt">label =</span> valid[[<span class="st">"log_price"</span>]])</span>
<span id="cb23-22"><a href="#cb23-22"></a></span>
<span id="cb23-23"><a href="#cb23-23"></a>params &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">learning_rate =</span> <span class="fl">0.5</span>,</span>
<span id="cb23-24"><a href="#cb23-24"></a>               <span class="dt">max_depth =</span> <span class="dv">6</span>,</span>
<span id="cb23-25"><a href="#cb23-25"></a>               <span class="dt">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb23-26"><a href="#cb23-26"></a>               <span class="dt">lambda =</span> <span class="dv">1</span>,</span>
<span id="cb23-27"><a href="#cb23-27"></a>               <span class="dt">colsample_bytree =</span> <span class="fl">0.8</span>)</span>
<span id="cb23-28"><a href="#cb23-28"></a></span>
<span id="cb23-29"><a href="#cb23-29"></a>fit_xgb &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgb.train</a></span>(params, </span>
<span id="cb23-30"><a href="#cb23-30"></a>                     <span class="dt">data =</span> dtrain,</span>
<span id="cb23-31"><a href="#cb23-31"></a>                     <span class="dt">watchlist =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">train =</span> dtrain, <span class="dt">valid =</span> dvalid),</span>
<span id="cb23-32"><a href="#cb23-32"></a>                     <span class="dt">nrounds =</span> <span class="dv">200</span>, </span>
<span id="cb23-33"><a href="#cb23-33"></a>                     <span class="dt">print_every_n =</span> <span class="dv">100</span>,</span>
<span id="cb23-34"><a href="#cb23-34"></a>                     <span class="dt">objective =</span> <span class="st">"reg:linear"</span>,</span>
<span id="cb23-35"><a href="#cb23-35"></a>                     <span class="dt">seed =</span> <span class="dv">2698</span>)</span>
<span id="cb23-36"><a href="#cb23-36"></a><span class="co">#&gt; [1]  train-rmse:6.291441 valid-rmse:6.284241 </span></span>
<span id="cb23-37"><a href="#cb23-37"></a><span class="co">#&gt; [101]    train-rmse:0.135278 valid-rmse:0.184681 </span></span>
<span id="cb23-38"><a href="#cb23-38"></a><span class="co">#&gt; [200]    train-rmse:0.114447 valid-rmse:0.187792</span></span></code></pre></div>
</div>
<div id="creating-the-flashlights" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-the-flashlights" class="anchor"></a>Creating the flashlights</h3>
<p>Let’s initialize a flashlight per model. Thanks to individual prediction functions, any model can be used in <code>flashlight</code>, even h2o and keras models.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>fl_mean &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(train<span class="op">$</span>log_price), <span class="dt">label =</span> <span class="st">"mean"</span>, </span>
<span id="cb24-2"><a href="#cb24-2"></a>                      <span class="dt">predict_function =</span> <span class="cf">function</span>(mod, X) <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(mod, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(X)))</span>
<span id="cb24-3"><a href="#cb24-3"></a>fl_lm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> fit_lm, <span class="dt">label =</span> <span class="st">"lm"</span>, </span>
<span id="cb24-4"><a href="#cb24-4"></a>                    <span class="dt">predict_function =</span> <span class="cf">function</span>(mod, X) <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(mod, <span class="kw">prep_lm</span>(X)))</span>
<span id="cb24-5"><a href="#cb24-5"></a>fl_rf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> fit_rf, <span class="dt">label =</span> <span class="st">"rf"</span>,</span>
<span id="cb24-6"><a href="#cb24-6"></a>                    <span class="dt">predict_function =</span> <span class="cf">function</span>(mod, X) <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(mod, X)<span class="op">$</span>predictions)</span>
<span id="cb24-7"><a href="#cb24-7"></a>fl_xgb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> fit_xgb, <span class="dt">label =</span> <span class="st">"xgb"</span>,</span>
<span id="cb24-8"><a href="#cb24-8"></a>                     <span class="dt">predict_function =</span> <span class="cf">function</span>(mod, X) <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(mod, <span class="kw">prep_xgb</span>(X, x)))</span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(fl_xgb)</span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co">#&gt; </span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">#&gt; Flashlight xgb </span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">#&gt; </span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">#&gt; Model:            Yes</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">#&gt; y:            No</span></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co">#&gt; w:            No</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">#&gt; by:           No</span></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="co">#&gt; data dim:         No</span></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="co">#&gt; predict_fct default:  FALSE</span></span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="co">#&gt; linkinv default:  TRUE</span></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="co">#&gt; metrics:      rmse</span></span></code></pre></div>
<p>What about all other relevant elements of a flashlight like the underlying data, the response name, metrics, retransformation functions etc? We could pass them to each of our flashlights. Or, we can combine the flashlights to a multiflashlight and pass additional common arguments there.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>fls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/multiflashlight.html">multiflashlight</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(fl_mean, fl_lm, fl_rf, fl_xgb), <span class="dt">y =</span> <span class="st">"log_price"</span>, <span class="dt">linkinv =</span> exp, </span>
<span id="cb25-2"><a href="#cb25-2"></a>                       <span class="dt">data =</span> valid, <span class="dt">metrics =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">rmse =</span> rmse, <span class="st">`</span><span class="dt">R-squared</span><span class="st">`</span> =<span class="st"> </span>r_squared))</span></code></pre></div>
<p>We could even extract these completed flashlights from the multiflashlight as if the latter is a list (actually it <em>is</em> a list with additional class <code>multiflashlight</code>).</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>fl_lm &lt;-<span class="st"> </span>fls<span class="op">$</span>lm</span></code></pre></div>
</div>
<div id="assess-performance" class="section level3">
<h3 class="hasAnchor">
<a href="#assess-performance" class="anchor"></a>Assess performance</h3>
<p>Let’s compare the models regarding their validation performance.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>perf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fls)</span>
<span id="cb27-2"><a href="#cb27-2"></a>perf</span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">#&gt; </span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">#&gt; I am an object with class(es) light_performance_multi, light_performance, light, list </span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">#&gt; </span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">#&gt; Tibbles:</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#&gt; </span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">#&gt;  data </span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">#&gt; # A tibble: 8 x 3</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co">#&gt;   metric        value label</span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="co">#&gt;   &lt;fct&gt;         &lt;dbl&gt; &lt;fct&gt;</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co">#&gt; 1 rmse       0.522    mean </span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="co">#&gt; 2 R-squared -0.000116 mean </span></span>
<span id="cb27-14"><a href="#cb27-14"></a><span class="co">#&gt; # ... with 6 more rows</span></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(perf)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Surprise, surprise: XGBoost is the winner! Now, black bars look a bit sad. Furthermore we would like to remove the x label.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(perf, <span class="dt">fill =</span> <span class="st">"darkred"</span>) <span class="op">+</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>The plot “politics” of <code>flashlight</code> is to provide simple graphics with minimal <code>ggplot</code>-tuning, so you are able to add your own modifications. If you are completely unhappy about the proposed plot (e.g. rather favour a scatterplot over a barplot), extract the <code>data</code> slot of <code>perf</code> and create the figure from scratch:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(perf<span class="op">$</span>data)</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="co">#&gt; # A tibble: 6 x 3</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="co">#&gt;   metric        value label</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co">#&gt;   &lt;fct&gt;         &lt;dbl&gt; &lt;fct&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="co">#&gt; 1 rmse       0.522    mean </span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="co">#&gt; 2 R-squared -0.000116 mean </span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="co">#&gt; 3 rmse       0.290    lm   </span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="co">#&gt; 4 R-squared  0.691    lm   </span></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="co">#&gt; 5 rmse       0.241    rf   </span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="co">#&gt; 6 R-squared  0.786    rf</span></span>
<span id="cb29-11"><a href="#cb29-11"></a></span>
<span id="cb29-12"><a href="#cb29-12"></a>perf<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> label, <span class="dt">y =</span> value, <span class="dt">group =</span> metric, <span class="dt">color =</span> metric)) <span class="op">+</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb29-15"><a href="#cb29-15"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.2</span>, <span class="dt">end =</span> <span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>The same logic holds for all other main functions in the <code>flashlight</code> package.</p>
<p>For performance considerations, the minimum required info in the (multi-)flashlight are: “y”, “predict_function”, “model”, “data” and “metrics”. The latter two can also be passed on the fly.</p>
</div>
<div id="variable-importance-1" class="section level3">
<h3 class="hasAnchor">
<a href="#variable-importance-1" class="anchor"></a>Variable importance</h3>
<p>Now let’s study variable importance of the explainers. By default, it is shown with respect to the first metric in the explainers. In our case, its the root-mean-squared error.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>(imp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fls, <span class="dt">n_max =</span> <span class="dv">1000</span>))</span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="co">#&gt; </span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="co">#&gt; I am an object with class(es) light_importance_multi, light_importance, light, list </span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="co">#&gt; </span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="co">#&gt; Tibbles:</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="co">#&gt; </span></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="co">#&gt;  data </span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="co">#&gt; # A tibble: 92 x 6</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="co">#&gt;   variable metric value_shuffled label value_original value</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="co">#&gt;   &lt;chr&gt;    &lt;fct&gt;           &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="co">#&gt; 1 id       rmse            0.530 mean           0.530     0</span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="co">#&gt; 2 date     rmse            0.530 mean           0.530     0</span></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="co">#&gt; # ... with 90 more rows</span></span>
<span id="cb30-14"><a href="#cb30-14"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>Oops, what happened? Too many variables were tested for permutation drop in rmse, namely <em>all</em> in the data set, except the response. While this can be useful in certain situations, we will just pass the vector <code>x</code> of covariables. Furthermore we replace the metric to mean-squared error.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>(imp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fls, <span class="dt">v =</span> x, <span class="dt">metric =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">mse =</span> mse)))</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="co">#&gt; </span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="co">#&gt; I am an object with class(es) light_importance_multi, light_importance, light, list </span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co">#&gt; </span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="co">#&gt; Tibbles:</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co">#&gt; </span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co">#&gt;  data </span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="co">#&gt; # A tibble: 32 x 6</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="co">#&gt;   variable metric value_shuffled label value_original value</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="co">#&gt;   &lt;chr&gt;    &lt;fct&gt;           &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="co">#&gt; 1 grade    mse             0.272 mean           0.272     0</span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="co">#&gt; 2 year     mse             0.272 mean           0.272     0</span></span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="co">#&gt; # ... with 30 more rows</span></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp, <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>If we want to just extract the names of the most relevant three variables, we just do the following:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw"><a href="../reference/most_important.html">most_important</a></span>(imp, <span class="dt">top_m =</span> <span class="dv">3</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="co">#&gt; [1] "grade"       "sqft_living" "zipcode"</span></span></code></pre></div>
<p>What about drop in R-squared? You don’t have to update the multiflashlight with that new property. Instead, you can pass it to <code>light_importance</code> on the fly. <code>flashlight</code> does not know if higher or lower values in the scoring function are better, so you will need to pass that information manually.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>imp_r2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fls, <span class="dt">metric =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">r_squared =</span> r_squared), </span>
<span id="cb33-2"><a href="#cb33-2"></a>                           <span class="dt">v =</span> x, <span class="dt">lower_is_better =</span> <span class="ot">FALSE</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp_r2, <span class="dt">fill =</span> <span class="st">"darkred"</span>) <span class="op">+</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Drop in R-squared"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-16-1.png" width="672"> Minimal required elements in the (multi-)flashlight are the same as in <code>light_performance</code>.</p>
<p>Note: If the calculations take too long (e.g. large query data), set <code>n_max</code> to some reasonable value. <code>light_importance</code> will then randomly pick <code>n_max</code> rows and use only these for assessment of importance.</p>
</div>
<div id="individual-conditional-expectation" class="section level3">
<h3 class="hasAnchor">
<a href="#individual-conditional-expectation" class="anchor"></a>Individual conditional expectation</h3>
<p>How do predictions change when <code>sqft_living</code> changes alone? We can investigate this question by looking at “Individual Conditional Expectation” (ICE) profiles of a couple of observations.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">n_max =</span> <span class="dv">30</span>, <span class="dt">seed =</span> <span class="dv">35</span>)</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(cp, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>The XGBoost profiles look wild - for real applications, setting monotonicity constraints would be an idea.</p>
<p>Note: Setting <code>seed</code> to a fixed value will ensure that the flashlights will consider the same rows. An alternative would be to pass a small subset of the data to <code>light_ice</code> and calculate all profiles or by passing row indices through <code>indices</code> for fixed selection.</p>
<p>Centered ICE profiles (“c-ICE”) can help to increase visibility of interactions.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">n_max =</span> <span class="dv">30</span>, <span class="dt">seed =</span> <span class="dv">35</span>, <span class="dt">center =</span> <span class="ot">TRUE</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(cp, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
</div>
<div id="partial-dependence-profiles" class="section level3">
<h3 class="hasAnchor">
<a href="#partial-dependence-profiles" class="anchor"></a>Partial dependence profiles</h3>
<p>If many ICE profiles (in our case 1000) are averaged, we get an impression on the average effect of the considered variable. Such curves are called <em>partial dependence profiles</em> (PD) resp. <em>partial dependence plots</em>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>pd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>)</span>
<span id="cb36-2"><a href="#cb36-2"></a>pd</span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">#&gt; </span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">#&gt; I am an object with class(es) light_profile_multi, light_profile, light, list </span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#&gt; </span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co">#&gt; Tibbles:</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co">#&gt; </span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co">#&gt;  data </span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="co">#&gt; # A tibble: 36 x 5</span></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="co">#&gt;   sqft_living counts   value label type              </span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="co">#&gt;         &lt;dbl&gt;  &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;             </span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="co">#&gt; 1         500   1000 464764. mean  partial dependence</span></span>
<span id="cb36-13"><a href="#cb36-13"></a><span class="co">#&gt; 2        1500   1000 464764. mean  partial dependence</span></span>
<span id="cb36-14"><a href="#cb36-14"></a><span class="co">#&gt; # ... with 34 more rows</span></span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pd)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<p>The <code>light_profile</code> function offers different ways to specify the evaluation points of the profiles, e.g. by explicitly passing such points.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>pd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">pd_evaluate_at =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">1000</span>, <span class="dv">4000</span>, <span class="dt">by =</span> <span class="dv">100</span>))</span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pd)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>For discrete variables:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>pd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"condition"</span>)</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pd)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
</div>
<div id="accumulated-local-effects-ale" class="section level3">
<h3 class="hasAnchor">
<a href="#accumulated-local-effects-ale" class="anchor"></a>Accumulated local effects (ALE)</h3>
<p>An approximation of main effects without Ceteris Paribus clause are <em>accumulated local effects</em> profiles [2]. They are based on accumulating local partial dependence slopes.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>ale &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a>ale</span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="co">#&gt; </span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="co">#&gt; I am an object with class(es) light_profile_multi, light_profile, light, list </span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="co">#&gt; </span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="co">#&gt; Tibbles:</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="co">#&gt; </span></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="co">#&gt;  data </span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="co">#&gt; # A tibble: 32 x 5</span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="co">#&gt;   sqft_living counts   value label type </span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="co">#&gt;         &lt;dbl&gt;  &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="co">#&gt; 1        1500   1000 464764. mean  ale  </span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="co">#&gt; 2        2500   1000 464764. mean  ale  </span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="co">#&gt; # ... with 30 more rows</span></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(ale)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-22-1.png" width="672"> Interestingly, the effects of the random forest and XGBoost are much steeper (and closer to the linear model) now for large houses compared to the effects from partial depencence.</p>
<p>Note: While equally sized x-breaks are easy to read, quantile binning usually leads to more stable results.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>, <span class="dt">cut_type =</span> <span class="st">"quantile"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<p>In order to calculate ICEs, PDs and ALEs, the following elements need to be available in the (multi-)flashlight: “predict_function”, “model”, “linkinv” and “data”. “data” can also be passed on the fly.</p>
</div>
<div id="profiles-of-predicted-values-residuals-and-response" class="section level3">
<h3 class="hasAnchor">
<a href="#profiles-of-predicted-values-residuals-and-response" class="anchor"></a>Profiles of predicted values, residuals, and response</h3>
<p>We can use the function <code>light_profile</code> not only to create partial dependence profiles but also to get profiles of predicted values (“M plots”), responses or residuals. Additionally, we can either use averages or quartiles as summary statistics.</p>
<p>Average predicted values versus the living area are as follows:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>format_y &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(x, <span class="dt">big.mark =</span> <span class="st">"'"</span>, <span class="dt">scientific =</span> <span class="ot">FALSE</span>)</span>
<span id="cb41-2"><a href="#cb41-2"></a></span>
<span id="cb41-3"><a href="#cb41-3"></a>pvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"predicted"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>, <span class="dt">big.mark =</span> <span class="st">"'"</span>)</span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pvp) <span class="op">+</span></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-24-1.png" width="672"></p>
<p>Note the formatting of y values as well as the <code>formatC</code> option <code>format = "fg"</code> and <code>big.mark</code> passed to the constructor of the x labels in order to improve basic appearance. We will recycle some of these settings for the next plots.</p>
<p>Similar the average response profiles (identical for all flashlights, to we only show one of them):</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>rvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl_lm, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"response"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>) </span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp) <span class="op">+</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>Same, but quartiles:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>rvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl_lm, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"response"</span>, </span>
<span id="cb43-2"><a href="#cb43-2"></a>                     <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>) </span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp) <span class="op">+</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<p>What about residuals? First, we remove the “mean” flashlight by setting it NULL.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>fls<span class="op">$</span>mean &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>rvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"residual"</span>, </span>
<span id="cb44-3"><a href="#cb44-3"></a>                     <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>) </span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp) <span class="op">+</span></span>
<span id="cb44-5"><a href="#cb44-5"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
<p>While the tree-based models have smaller residuals and medians close to 0, the linear model shows residual curvature that could be captured by representing <code>sqft_living</code> by more parameters.</p>
<p>If unhappy about the “group by” strategy, set <code>swap_dim</code> to TRUE.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp, <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>) <span class="op">+</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-28-1.png" width="672"></p>
<p>For less bars, set <code>n_bins</code> in <code>light_profile</code>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>rvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"residual"</span>, </span>
<span id="cb46-2"><a href="#cb46-2"></a>                     <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>) </span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp, <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>) <span class="op">+</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-29-1.png" width="672"></p>
<p>In the same way as diverging ICE profiles give a clou of presence of interactions, we can use the option <code>stats = "quartiles"</code> (with <code>pd_center = TRUE</code>) to show divergence of the centered ICE profiles as boxes (predictions at log-scale to suppress interaction-like effects of the retransformation function:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>rvp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">use_linkinv =</span> <span class="ot">FALSE</span>, </span>
<span id="cb47-2"><a href="#cb47-2"></a>                     <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">pd_center =</span> <span class="ot">TRUE</span>) </span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(rvp)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-30-1.png" width="672"></p>
<p>For prediction profiles, the same elements as for ICE/PDs are required, while for response profiles we need “y”, “linkinv” and “data”. “data” can also be passed on the fly.</p>
</div>
<div id="visualizing-different-types-of-profiles-as-effects-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#visualizing-different-types-of-profiles-as-effects-plot" class="anchor"></a>Visualizing different types of profiles as “effects” plot</h3>
<p>In assessing the model quality, it is often useful to visualize</p>
<ul>
<li><p>response profile (quartiles or means),</p></li>
<li><p>average predictions, and</p></li>
<li><p>model effects (partial dependence profiles, or accumulated local effects)</p></li>
</ul>
<p>in the same plot and for each input variable. The <code>flashlight</code> package offers the function <code>light_effects</code> combine such profile plots:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fl_lm, <span class="dt">v =</span> <span class="st">"condition"</span>) </span>
<span id="cb48-2"><a href="#cb48-2"></a>p &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(eff) <span class="op">+</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span>
<span id="cb48-4"><a href="#cb48-4"></a>p</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-31-1.png" width="672"></p>
<p>Let’s add counts to see if the gaps between response and predicted profiles are problematic or just due to small samples.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw"><a href="../reference/plot_counts.html">plot_counts</a></span>(p, eff, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-32-1.png" width="672"></p>
<p>The biggest gaps occur with very rare conditions, so the model looks quite fine.</p>
<p>Note: Due to retransformation from log scale, the response profile is slightly higher than the profile of predicted values. If we would evaluate on the modelled log scale, that gap would vanish.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fl_lm, <span class="dt">v =</span> <span class="st">"condition"</span>, <span class="dt">linkinv =</span> I) </span>
<span id="cb50-2"><a href="#cb50-2"></a>p &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(eff, <span class="dt">use =</span> <span class="st">"all"</span>) <span class="op">+</span></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y) <span class="op">+</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Effects plot on modelled log scale"</span>)</span>
<span id="cb50-5"><a href="#cb50-5"></a>p</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-33-1.png" width="672"></p>
<p>Besides adding counts to the figure, representing observed responses as boxplots (no whiskers and outliers in order to avoid too large y scale) might help to judge if there is a problematic misfit.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fl_lm, <span class="dt">v =</span> <span class="st">"condition"</span>, <span class="dt">stats =</span> <span class="st">"quartiles"</span>) </span>
<span id="cb51-2"><a href="#cb51-2"></a>p &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(eff, <span class="dt">rotate_x =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="st">   </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="kw"><a href="../reference/plot_counts.html">plot_counts</a></span>(p, eff, <span class="dt">fill =</span> <span class="st">"blue"</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">width =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-34-1.png" width="672"></p>
<p>The <code>plot</code> method of <code>light_effects</code> allows to hide certain plot element if it looks too dense.</p>
</div>
<div id="variable-contribution-breakdown-for-single-observation" class="section level3">
<h3 class="hasAnchor">
<a href="#variable-contribution-breakdown-for-single-observation" class="anchor"></a>Variable contribution breakdown for single observation</h3>
<p>Besides global effects, we can use <code>light_breakdown</code> to calculate variable impact on one single (log) prediction.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>bd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fl_lm, <span class="dt">new_obs =</span> valid[<span class="dv">1</span>, ], <span class="dt">v =</span> x, <span class="dt">n_max =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">74</span>) </span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(bd, <span class="dt">size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-35-1.png" width="672"> We have set <code>n_max</code> to 1000 in order to save time. The only variable with positive impact on the prediction is “age”. The other variables have a negative impact compared to the 1000 reference observations. We could limit the figure to the four most relevant variables. In this case, the final bar would show the impact of all other variables together.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>bd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fl_lm, <span class="dt">new_obs =</span> valid[<span class="dv">1</span>, ], <span class="dt">v =</span> x, <span class="dt">n_max =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">74</span>, <span class="dt">top_m =</span> <span class="dv">4</span>) </span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(bd)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-36-1.png" width="672"></p>
</div>
</div>
<div id="grouped-calculations" class="section level2">
<h2 class="hasAnchor">
<a href="#grouped-calculations" class="anchor"></a>Grouped calculations</h2>
<p>A key feature of the <code>flashlight</code> package is to support grouped results. You can initialize the (multi-)flashlight with column names of one or many grouping variables or ask for grouped calculations in all major <code>flashlight</code> functions. Plots are adapted accordingly.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>fls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/multiflashlight.html">multiflashlight</a></span>(fls, <span class="dt">by =</span> <span class="st">"year"</span>)</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="co"># Performance</span></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fls)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="st">  </span><span class="kw">scale_fill_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.1</span>, <span class="dt">end =</span> <span class="fl">0.9</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-1.png" width="672"></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="co"># With swapped dimension</span></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fls), <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="st">  </span><span class="kw">scale_fill_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.1</span>, <span class="dt">end =</span> <span class="fl">0.9</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-2.png" width="672"></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>  </span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="co"># Importance</span></span>
<span id="cb56-3"><a href="#cb56-3"></a>imp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fls, <span class="dt">v =</span> x)</span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp, <span class="dt">top_m =</span> <span class="dv">4</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-3.png" width="672"></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(imp, <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-4.png" width="672"></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="co"># Effects: ICE</span></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">seed =</span> <span class="dv">4345</span>), </span>
<span id="cb58-4"><a href="#cb58-4"></a>     <span class="dt">alpha =</span> <span class="fl">0.8</span>, <span class="dt">facet_scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.1</span>, <span class="dt">end =</span> <span class="fl">0.9</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb58-6"><a href="#cb58-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-5.png" width="672"></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a></span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="co"># c-ICE</span></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">seed =</span> <span class="dv">4345</span>, <span class="dt">center =</span> <span class="ot">TRUE</span>), </span>
<span id="cb59-4"><a href="#cb59-4"></a>     <span class="dt">alpha =</span> <span class="fl">0.8</span>, <span class="dt">facet_scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb59-5"><a href="#cb59-5"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">begin =</span> <span class="fl">0.1</span>, <span class="dt">end =</span> <span class="fl">0.9</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-6.png" width="672"></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a></span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="co"># Effects: Partial dependence</span></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-7.png" width="672"></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>), <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-8.png" width="672"></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">pd_center =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-9.png" width="672"></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="co"># Effects: ALE</span></span>
<span id="cb63-3"><a href="#cb63-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-10.png" width="672"></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>), <span class="dt">swap_dim =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-11.png" width="672"></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a></span>
<span id="cb65-2"><a href="#cb65-2"></a><span class="co"># Effects: Combined plot (only one flashlight) </span></span>
<span id="cb65-3"><a href="#cb65-3"></a><span class="co"># -&gt; we need to manually pass "by" or update the single flashlight</span></span>
<span id="cb65-4"><a href="#cb65-4"></a>z &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fls, <span class="dt">v =</span> <span class="st">"sqft_living"</span>, <span class="dt">format =</span> <span class="st">"fg"</span>, </span>
<span id="cb65-5"><a href="#cb65-5"></a>                   <span class="dt">stats =</span> <span class="st">"quartiles"</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>, <span class="dt">by =</span> <span class="ot">NULL</span>)</span>
<span id="cb65-6"><a href="#cb65-6"></a>p &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(z) <span class="op">+</span><span class="st"> </span></span>
<span id="cb65-7"><a href="#cb65-7"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> format_y) <span class="op">+</span></span>
<span id="cb65-8"><a href="#cb65-8"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="fl">3e6</span>))</span>
<span id="cb65-9"><a href="#cb65-9"></a><span class="kw"><a href="../reference/plot_counts.html">plot_counts</a></span>(p, z, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-12.png" width="672"></p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a></span>
<span id="cb66-2"><a href="#cb66-2"></a><span class="co"># Variable contribution breakdown for single observation (on log-scale)</span></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="co"># -&gt; "by" selects the relevant rows in data/valid</span></span>
<span id="cb66-4"><a href="#cb66-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fl_lm, <span class="dt">new_obs =</span> valid[<span class="dv">1</span>, ], <span class="dt">v =</span> x, <span class="dt">top_m =</span> <span class="dv">3</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-37-13.png" width="672"></p>
</div>
<div id="working-with-case-weights" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-case-weights" class="anchor"></a>Working with case weights</h2>
<p>In many applications, case weights are involved. All main functions in <code>flashlight</code> deal with them automatically. The only thing you need to do is to pass the column name of the column with case weights when initializing the (multi-)flashlight.</p>
<p>Let’s go through the initial iris example again with (artificial) case weights:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># Add weight info to the flashlight</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>fl_weighted &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(fl, <span class="dt">w =</span> <span class="st">"Petal.Length"</span>, <span class="dt">label =</span> <span class="st">"ols weighted"</span>)</span>
<span id="cb67-3"><a href="#cb67-3"></a>fls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/multiflashlight.html">multiflashlight</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(fl, fl_weighted))</span>
<span id="cb67-4"><a href="#cb67-4"></a></span>
<span id="cb67-5"><a href="#cb67-5"></a><span class="co"># Performance: rmse and R-squared</span></span>
<span id="cb67-6"><a href="#cb67-6"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fls))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-1.png" width="672"></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fls, <span class="dt">by =</span> <span class="st">"Species"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-2.png" width="672"></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a></span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="co"># Variable importance by drop in rmse</span></span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fls, <span class="dt">by =</span> <span class="st">"Species"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-3.png" width="672"></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="co"># ICE profiles for Petal.Width </span></span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="co"># (not affected by weights because nothing is being aggregated)</span></span>
<span id="cb70-4"><a href="#cb70-4"></a>indices &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">10</span>, <span class="dv">150</span>, <span class="dt">by =</span> <span class="dv">10</span>)</span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">indices =</span> indices), <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-4.png" width="672"></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>, <span class="dt">indices =</span> indices))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-5.png" width="672"></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="co"># c-ICE -&gt; lines overlap, no interactions at all</span></span>
<span id="cb72-3"><a href="#cb72-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">indices =</span> indices, <span class="dt">center =</span> <span class="ot">TRUE</span>), <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-6.png" width="672"></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>, <span class="dt">indices =</span> indices, <span class="dt">center =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-7.png" width="672"></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a></span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="co"># Partial dependence profiles for Petal.Width</span></span>
<span id="cb74-3"><a href="#cb74-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-8.png" width="672"></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-9.png" width="672"></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a></span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="co"># ALE profiles for Petal.Width</span></span>
<span id="cb76-3"><a href="#cb76-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-10.png" width="672"></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">by =</span> <span class="st">"Species"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-11.png" width="672"></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a></span>
<span id="cb78-2"><a href="#cb78-2"></a><span class="co"># Observed, predicted, and partial dependence profiles</span></span>
<span id="cb78-3"><a href="#cb78-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-12.png" width="672"></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fls, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">stats =</span> <span class="st">"quartiles"</span>)</span>
<span id="cb79-2"><a href="#cb79-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(eff) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb79-3"><a href="#cb79-3"></a><span class="st">  </span><span class="kw"><a href="../reference/plot_counts.html">plot_counts</a></span>(eff, <span class="dt">alpha =</span> <span class="fl">0.2</span>, <span class="dt">fill =</span> <span class="st">"blue"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-13.png" width="672"></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a></span>
<span id="cb80-2"><a href="#cb80-2"></a><span class="co"># Variable contribution breakdown for single observation (on log-scale)</span></span>
<span id="cb80-3"><a href="#cb80-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fls, <span class="dt">new_obs =</span> iris[<span class="dv">2</span>, ]), <span class="dt">size =</span> <span class="fl">2.5</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-38-14.png" width="672"></p>
</div>
<div id="binary-classification" class="section level2">
<h2 class="hasAnchor">
<a href="#binary-classification" class="anchor"></a>Binary classification</h2>
<p>The <code>flashlight</code> package works for numeric responses including binary targets.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>ir &lt;-<span class="st"> </span>iris</span>
<span id="cb81-2"><a href="#cb81-2"></a>ir<span class="op">$</span>virginica &lt;-<span class="st"> </span>ir<span class="op">$</span>Species <span class="op">==</span><span class="st"> "virginica"</span></span>
<span id="cb81-3"><a href="#cb81-3"></a></span>
<span id="cb81-4"><a href="#cb81-4"></a>fit &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(virginica <span class="op">~</span><span class="st"> </span>Sepal.Length <span class="op">+</span><span class="st"> </span>Petal.Width, <span class="dt">data =</span> ir, <span class="dt">family =</span> binomial)</span>
<span id="cb81-5"><a href="#cb81-5"></a></span>
<span id="cb81-6"><a href="#cb81-6"></a><span class="co"># Make flashlight</span></span>
<span id="cb81-7"><a href="#cb81-7"></a>fl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flashlight.html">flashlight</a></span>(<span class="dt">model =</span> fit, <span class="dt">data =</span> ir, <span class="dt">y =</span> <span class="st">"virginica"</span>, <span class="dt">label =</span> <span class="st">"lr"</span>,</span>
<span id="cb81-8"><a href="#cb81-8"></a>                 <span class="dt">metrics =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">logLoss =</span> logLoss, <span class="dt">AUC =</span> AUC), </span>
<span id="cb81-9"><a href="#cb81-9"></a>                 <span class="dt">predict_function =</span> <span class="cf">function</span>(m, d) <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(m, d, <span class="dt">type =</span> <span class="st">"response"</span>))</span>
<span id="cb81-10"><a href="#cb81-10"></a></span>
<span id="cb81-11"><a href="#cb81-11"></a><span class="co"># Performance: rmse and R-squared</span></span>
<span id="cb81-12"><a href="#cb81-12"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_performance.html">light_performance</a></span>(fl), <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-1.png" width="672"></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a></span>
<span id="cb82-2"><a href="#cb82-2"></a><span class="co"># Variable importance by drop in rmse</span></span>
<span id="cb82-3"><a href="#cb82-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_importance.html">light_importance</a></span>(fl, <span class="dt">v =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sepal.Length"</span>, <span class="st">"Petal.Width"</span>)), <span class="dt">fill =</span> <span class="st">"darkred"</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-2.png" width="672"></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a></span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="co"># ICE profiles for Petal.Width</span></span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>), <span class="dt">alpha =</span> <span class="fl">0.4</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-3.png" width="672"></p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a></span>
<span id="cb84-2"><a href="#cb84-2"></a><span class="co"># c-ICE profiles for Petal.Width</span></span>
<span id="cb84-3"><a href="#cb84-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_ice.html">light_ice</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">center =</span> <span class="ot">TRUE</span>), <span class="dt">alpha =</span> <span class="fl">0.4</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-4.png" width="672"></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a></span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="co"># Partial dependence profiles for Petal.Width</span></span>
<span id="cb85-3"><a href="#cb85-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-5.png" width="672"></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a></span>
<span id="cb86-2"><a href="#cb86-2"></a><span class="co"># ALE profiles for Petal.Width</span></span>
<span id="cb86-3"><a href="#cb86-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_profile.html">light_profile</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>, <span class="dt">type =</span> <span class="st">"ale"</span>, <span class="dt">cut_type =</span> <span class="st">"quantile"</span>))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-6.png" width="672"></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a></span>
<span id="cb87-2"><a href="#cb87-2"></a><span class="co"># Observed, predicted, and partial dependence profiles</span></span>
<span id="cb87-3"><a href="#cb87-3"></a>eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/light_effects.html">light_effects</a></span>(fl, <span class="dt">v =</span> <span class="st">"Petal.Width"</span>)</span>
<span id="cb87-4"><a href="#cb87-4"></a><span class="kw"><a href="../reference/plot_counts.html">plot_counts</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(eff, <span class="dt">use =</span> <span class="st">"all"</span>), eff, <span class="dt">alpha =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-7.png" width="672"></p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a></span>
<span id="cb88-2"><a href="#cb88-2"></a><span class="co"># Variable contribution breakdown for single observation</span></span>
<span id="cb88-3"><a href="#cb88-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="../reference/light_breakdown.html">light_breakdown</a></span>(fl, <span class="dt">new_obs =</span> ir[<span class="dv">2</span>, ], <span class="dt">v =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sepal.Length"</span>, <span class="st">"Petal.Width"</span>)))</span></code></pre></div>
<p><img src="flashlight_files/figure-html/unnamed-chunk-39-8.png" width="672"></p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>[1] Molnar C. (2019). Interpretable machine learning. A Guide for Making Black Box Models Explainable (<a href="https://christophm.github.io/interpretable-ml-book/" class="uri">https://christophm.github.io/interpretable-ml-book/</a>).</p>
<p>[2] Fisher A., Rudin C., Dominici F. (2018). All Models are Wrong but many are Useful: Variable Importance for Black-Box, Proprietary, or Misspecified Prediction Models, using Model Class Reliance. ArXiv (<a href="https://arxiv.org/abs/1801.01489" class="uri">https://arxiv.org/abs/1801.01489</a>).</p>
<p>[3] Goldstein, A. et al. (2015). Peeking inside the black box: Visualizing statistical learning with plots of individual conditional expectation. Journal of Computational and Graphical Statistics, 24:1 (<a href="https://doi.org/10.1080/10618600.2014.907095" class="uri">https://doi.org/10.1080/10618600.2014.907095</a>).</p>
<p>[4] Friedman J. H. (2001). Greedy function approximation: A gradient boosting machine. The Annals of Statistics, 29:1189–1232 (<a href="https://doi.org/10.1214/aos/1013203451" class="uri">https://doi.org/10.1214/aos/1013203451</a>).</p>
<p>[5] Apley D. W. (2016). Visualizing the effects of predictor variables in black box supervised learning models. ArXiv (<a href="https://arXiv:1612.08468" class="uri">https://arXiv:1612.08468</a>).</p>
<p>[6] Gosiewska A. and Biecek P. (2019). IBREAKDOWN: Uncertainty of model explanations for non-additive predictive models. ArXiv (<a href="https://arxiv.org/abs/1903.11420" class="uri">https://arxiv.org/abs/1903.11420</a>).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#background">Background</a></li>
      <li><a href="#installation-of-flashlight">Installation of <code>flashlight</code></a></li>
      <li><a href="#teaser">Teaser</a></li>
      <li><a href="#flashlights-and-multiflashlights">flashlights and multiflashlights</a></li>
      <li><a href="#example">Example</a></li>
      <li><a href="#grouped-calculations">Grouped calculations</a></li>
      <li><a href="#working-with-case-weights">Working with case weights</a></li>
      <li><a href="#binary-classification">Binary classification</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
